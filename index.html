<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- T√≠tulo da aba -->
  <title>ENAI - Solu√ß√µes Inteligentes</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="enaifavicon.png">

  <!-- Para deixar mais completo e compat√≠vel com iPhones, iPads e Windows -->
  <link rel="apple-touch-icon" sizes="180x180" href="ENAI.png">
  <meta name="msapplication-TileImage" content="ENAI.png">
  <meta name="msapplication-TileColor" content="#ffffff">
  
<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<!-- Leaflet (OpenStreetMap) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
<style>
:root{
  --blue-1:#007bff;
  --blue-2:#0046a3;
  --bg:#f5f7fa;
  --muted:#666;
  --green:#1db954;
  --red:#e53935;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:'Segoe UI',Tahoma,Arial,sans-serif;
  background:var(--bg);
  color:#222;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}
header{
  background:linear-gradient(to right,var(--blue-1),var(--blue-2));
  padding:15px 30px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  color:white;
  box-shadow:0 4px 10px rgba(0,0,0,0.18);
  position:relative;
  z-index:3;
}
header h2{margin:0;font-size:20px;letter-spacing:0.2px;}
.logo-header{position:absolute;top:10px;right:30px;}
.logo-header img{height:35px;border-radius:10px;}
.wave-bg{
  position:absolute;top:0;left:0;width:100%;height:750px;
  background:url('download.jfif') no-repeat center top;
  background-size:cover;z-index:0;
}
.container{
  max-width:880px;
  margin:100px auto;
  background:#fff;
  border-radius:18px;
  box-shadow:0 6px 26px rgba(0,0,0,0.12);
  padding:36px;
  position:relative;
  z-index:2;
  min-height:420px;
  overflow:hidden;
}
.page{
  opacity:0;
  transform:translateY(18px);
  pointer-events:none;
  transition:opacity .38s ease,transform .38s ease;
  position:absolute;
  width:calc(100% - 72px);
  left:36px;top:36px;
}
.page.active{
  opacity:1;
  transform:translateY(0);
  pointer-events:auto;
  position:relative;
  width:auto;left:auto;top:auto;
}
h1{color:var(--blue-2);text-align:center;margin-top:0;}
input,select,textarea{
  width:100%;padding:10px 12px;margin:8px 0;border-radius:8px;
  border:1px solid #d5dbe3;font-size:14px;
}
button{
  background:var(--blue-1);color:#fff;border:none;border-radius:10px;
  padding:10px 16px;margin:6px 6px 0 0;cursor:pointer;font-weight:600;
  transition:background .18s ease,transform .06s ease;
}
button:hover{background:var(--blue-2);transform:translateY(-2px);}
.muted{color:var(--muted);font-size:13px;}
.row{display:flex;gap:12px;flex-wrap:wrap;}
.col{flex:1;min-width:150px;}
.on{color:var(--green);font-weight:700;}
.off{color:var(--red);font-weight:700;}
.slider{width:100%;margin:6px 0;-webkit-appearance:none;height:8px;background:#e6e9ee;border-radius:6px;outline:none;}
.slider::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;border-radius:50%;background:var(--blue-1);cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,0.12);}
.vehicle-card{display:flex;gap:16px;align-items:center;border:1px solid #eef2f6;padding:12px;border-radius:12px;}
.vehicle-img{width:170px;height:120px;background:#f3f5f7;border-radius:10px;object-fit:cover;border:2px solid var(--blue-1);}
#mapid{width:100%;height:300px;border-radius:10px;margin-top:10px;}
@media(max-width:720px){
  .container{margin:60px 12px;padding:20px;}
  .page{width:100%;left:0;top:0;}
  .vehicle-img{width:120px;height:90px;}
}
</style>
</head>
<body>
<header>
  <h2 class="font-bold">ENAI - Solu√ß√µes Inteligentes</h2>
  <div class="logo-header"><img src="ENAI.png" alt="Logo"></div>
</header>
<div class="wave-bg"></div>

<div class="container">
  <!-- LOGIN -->
  <div id="loginPage" class="page active">
    <h1 class="text-4xl font-bold">Login</h1>
    <input id="loginEmail" type="email" placeholder="Email">
    <input id="loginSenha" type="password" placeholder="Senha">
    <div>
      <button onclick="login()">Entrar</button>
      <button onclick="showPage('cadastroPage')">Cadastre-se</button>
    </div>
    <p class="muted" style="margin-top:10px;"><a href="#" onclick="resetarSenha()">Esqueci minha senha</a></p>
  </div>

  <!-- CADASTRO -->
  <div id="cadastroPage" class="page">
    <h1 class="text-4xl font-bold">Cadastro</h1>
    <input id="cadNome" placeholder="Nome completo">
    <input id="cadEmail" placeholder="Email">
    <input id="cadTel" placeholder="Telefone">
    <input id="cadCPF" placeholder="CPF">
    <input id="cadEndereco" placeholder="Endere√ßo">
    <input id="cadSenha" type="password" placeholder="Senha">
    <input id="cadKey" placeholder="Chave de Ativa√ß√£o">
    <div>
      <button onclick="cadastro()">Cadastrar</button>
      <button onclick="showPage('loginPage')">Voltar</button>
    </div>
  </div>

  <!-- PAINEL -->
  <div id="painelPage" class="page">
    <h1 class="text-4xl font-bold">Painel do Ve√≠culo</h1>
    <div style="margin-top:12px;" class="flex flex-col flex-wrap md:flex-row">
      <button onclick="showPage('perfilPage')">Meu Perfil</button>
      <button onclick="showPage('meuVeiculoPage')">Meu Ve√≠culo</button>
      <button onclick="showPage('travaPage')">Trava de Portas</button>
      <button onclick="showPage('vidrosPage')">Vidros</button>
      <button onclick="showPage('motorPage')">Motor</button>
      <button onclick="showPage('arPage')">Ar Condicionado</button>
      <button onclick="showPage('radioPage')">R√°dio</button>
      <button onclick="abrirGPS()">GPS</button>
      <button onclick="showPage('vozPage')">Comando de Voz</button>
      <button onclick="showPage('manutPage')">Plano de Manuten√ß√£o</button>
      <button onclick="logout()">Sair</button>
    </div>
  </div>

 <!-- PERFIL -->
  <div id="perfilPage" class="page">
    <h1 class="text-4xl font-bold">Meu Perfil</h1>
    <label>Nome</label>
    <input id="perfilNome" placeholder="Nome completo">
    <label>Email</label>
    <input id="perfilEmail" placeholder="Email" disabled>
    <label>Telefone</label>
    <input id="perfilTel" placeholder="Telefone">
    <label>CPF</label>
    <input id="perfilCPF" placeholder="CPF">
    <label>Endere√ßo</label>
    <input id="perfilEndereco" placeholder="Endere√ßo">
    <label>Chave de Ativa√ß√£o</label>
    <input id="perfilKey" placeholder="Chave de Ativa√ß√£o" disabled>

    <h1 style="font-size:18px; margin-top:12px;">Dados do Ve√≠culo</h1>
    <label>Fabricante</label>
    <input id="perfilFabricante" placeholder="Fabricante">
    <label>Modelo</label>
    <input id="perfilModelo" placeholder="Modelo">
    <div class="row">
      <div class="col">
        <label>Placa</label>
        <input id="perfilPlaca" placeholder="Placa">
      </div>
      <div class="col">
        <label>Ano</label>
        <input id="perfilAno" placeholder="Ano">
      </div>
    </div>
    <label>Cor</label>
    <input id="perfilCor" placeholder="Cor">
    <div style="margin-top:10px;">
      <button onclick="salvarPerfilCompleto()">Salvar</button>
      <button onclick="showPage('painelPage')">Voltar</button>
    </div>
  </div>

<!-- MEU VE√çCULO -->
<div id="meuVeiculoPage" class="page">
  <h1 class="text-4xl font-bold">Meu Ve√≠culo</h1>
  <div class="vehicle-card" style="margin-top:12px; display: flex; align-items: center; gap: 12px;">
    <img id="veiculoFoto" src="" alt="Foto do ve√≠culo" style="display:none; width:120px; height:auto; border-radius:8px; margin-top:10px;">
    <div style="flex: 1;">
      <div><strong>Fabricante:</strong> <span id="viewFabricante">‚Äî</span></div>
      <div><strong>Modelo:</strong> <span id="viewModelo">‚Äî</span></div>
      <div><strong>Placa:</strong> <span id="viewPlaca">‚Äî</span></div>
      <div><strong>Ano:</strong> <span id="viewAno">‚Äî</span></div>
      <div><strong>Cor:</strong> <span id="viewCor">‚Äî</span></div>
    </div>
  </div>

  <div style="margin-top:12px;">
    <label>Alterar foto do ve√≠culo</label><br>
    <input type="file" id="fotoVeiculoInput" accept="image/*" onchange="uploadFotoVeiculoFromPanel(event)">
  </div>

  <div style="margin-top:12px;">
    <button onclick="carregarVeiculo()">Atualizar Dados</button>
    <button onclick="showPage('painelPage')">Voltar</button>
  </div>
</div>

    <!-- TRAVAS -->
  <div id="travaPage" class="page">
    <h1>Trava de Portas</h1>
    <div style="margin-top:12px;">
      <div style="margin-bottom:8px;"><strong>Esq Dianteira:</strong> <span id="travaLed1" class="on">Fechada</span> <button onclick="toggleTrava(1)">Abrir</button></div>
      <div style="margin-bottom:8px;"><strong>Esq Traseira:</strong> <span id="travaLed2" class="on">Fechada</span> <button onclick="toggleTrava(2)">Abrir</button></div>
      <div style="margin-bottom:8px;"><strong>Dir Dianteira:</strong> <span id="travaLed3" class="on">Fechada</span> <button onclick="toggleTrava(3)">Abrir</button></div>
      <div style="margin-bottom:8px;"><strong>Dir Traseira:</strong> <span id="travaLed4" class="on">Fechada</span> <button onclick="toggleTrava(4)">Abrir</button></div>
      <div style="margin-bottom:8px;"><strong>Porta-malas:</strong> <span id="travaLed5" class="on">Fechada</span> <button onclick="toggleTrava(5)">Abrir</button></div>
    </div>
    <div style="margin-top:12px;">
      <button onclick="abrirTudo()">Abrir Tudo</button>
      <button onclick="fecharTudo()">Fechar Tudo</button>
      <button onclick="showPage('painelPage')">Voltar</button>
    </div>
  </div>

  <!-- VIDROS -->
  <div id="vidrosPage" class="page">
    <h1 class="text-4xl font-bold">Vidros</h1>
    <div style="margin-top:12px;">
      <label>Vidro Dianteiro Esquerdo: <span id="v1pct">100%</span></label>
      <input id="vidro1" class="slider" type="range" min="0" max="100" value="100" oninput="updateVidro(1)">
      <label>Vidro Dianteiro Direito: <span id="v2pct">100%</span></label>
      <input id="vidro2" class="slider" type="range" min="0" max="100" value="100" oninput="updateVidro(2)">
      <label>Vidro Traseiro Esquerdo: <span id="v3pct">100%</span></label>
      <input id="vidro3" class="slider" type="range" min="0" max="100" value="100" oninput="updateVidro(3)">
      <label>Vidro Traseiro Direito: <span id="v4pct">100%</span></label>
      <input id="vidro4" class="slider" type="range" min="0" max="100" value="100" oninput="updateVidro(4)">
    </div>
    <div style="margin-top:12px;">
      <button onclick="showPage('painelPage')">Voltar</button>
    </div>
  </div>

  <!-- MOTOR -->
<div id="motorPage" class="page">
  <h1 class="text-4xl font-bold">Motor</h1>
  <p>Status: <span id="motorStatus" class="off">Desligado</span></p>

  <div style="margin-top: 16px;">
    <!-- Bot√£o com √≠cone -->
    <button id="motorPower" onclick="toggleMotor()"
      style="background-color:#003366; border:none; border-radius:50%; padding:18px; cursor:pointer; transition: background-color 0.3s;">
      <img src="70051.png" alt="Power" width="80" height="80">
    </button>

    <button style="margin-left:12px;" onclick="showPage('painelPage')">Voltar</button>
  </div>
</div>

  <!-- AR -->
<div id="arPage" class="page">
  <h1 class="text-4xl font-bold">Ar Condicionado</h1>
  <p>Status: <span id="statusAr" class="off">Desligado</span></p>

  <div style="margin-top:16px;">
    <!-- Bot√£o com √≠cone -->
    <button id="arPower" onclick="toggleAr()"
      style="background-color:#003366; border:none; border-radius:50%; padding:18px; cursor:pointer; transition: background-color 0.3s;">
      <img src="70051.png" alt="Power" width="40" height="40">
    </button>

    <button onclick="alterarTemp(-1)" style="margin-left:16px;">-</button>
    <span style="margin:0 12px">Temperatura: <strong><span id="tempAr">22</span>¬∞C</strong></span>
    <button onclick="alterarTemp(1)">+</button>

    <button style="margin-left:12px;" onclick="showPage('painelPage')">Voltar</button>
  </div>
</div>

  <!-- RADIO -->
  <div id="radioPage" class="page">
    <h1 class="text-4xl font-bold">R√°dio</h1>
    <p>Frequ√™ncia: <span id="radioFreq">99.5</span> MHz</p>
    <div>
      <button onclick="alterarFreq(-0.1)">-</button>
      <button onclick="alterarFreq(0.1)">+</button>
      <button onclick="showPage('painelPage')">Voltar</button>
    </div>
  </div>

  <!-- GPS -->
  <div id="gpsPage" class="page">
    <h1 class="text-4xl font-bold">GPS - Localiza√ß√£o Atual</h1>
    <div id="mapid">Carregando mapa...</div>
    <button style="margin-top:12px;" onclick="showPage('painelPage')">Voltar</button>
  </div>

<!-- COMANDO DE VOZ -->
<div id="vozPage" class="page">
  <h1 class="text-4xl font-bold">üéôÔ∏è Comando de Voz</h1>

  <div style="margin-top: 12px;">
    <p id="vozStatus">‚úÖ Aguardando comando...</p>

    <p><strong>Motor:</strong> <span id="vozMotor">‚Äî</span></p>
    <p><strong>Ar-condicionado:</strong> <span id="vozAr">‚Äî</span></p>
    <p><strong>Temperatura:</strong> <span id="vozTemp">‚Äî</span></p>
    <p><strong>R√°dio:</strong> <span id="vozRadio">‚Äî</span></p>
    <p><strong>Travas:</strong> <span id="vozTravas">‚Äî</span></p>
    <p><strong>Vidros:</strong> <span id="vozVidros">‚Äî</span></p>
  </div>

  <div style="margin-top: 16px;">
    <button id="btnVoz">üé§ Iniciar comando de voz</button>
    <button id="btnAtualizar">üîÑ Atualizar status</button>
    <button id="btnVoltar" onclick="showPage('painelPage')">Voltar</button>
  </div>
</div>

  <!-- MANUTEN√á√ÉO -->
  <div id="manutPage" class="page">
    <h1 class="text-4xl font-bold">Plano de Manuten√ß√£o</h1>
    <p>Controle de revis√µes e alertas do ve√≠culo:</p>
    <ul>
      <li>Troca de √≥leo ‚Äì a cada 10.000 km</li>
      <li>Revis√£o de freios ‚Äì a cada 15.000 km</li>
      <li>Troca de filtro de ar ‚Äì a cada 20.000 km</li>
    </ul>
    <button onclick="showPage('painelPage')">Voltar</button>
  </div>
</div>

<script>
/* ===== ESTADO GLOBAL DO CARRO ===== */
if (!window.estadoCarro) {
  window.estadoCarro = {
    motor: false,
    ar: false,
    temperatura: 22,
    radio: 99.9,
    travas: [true, true, true, true, true],
    vidros: [0, 0, 0, 0]
  };
  console.log("‚úÖ estadoCarro criado:", window.estadoCarro);
}

/* ===== FIREBASE ===== */
const firebaseConfig = {
  apiKey: "AIzaSyBmPCQdVhQZt51ZnFwur8nRmGIpRdWBfEs",
  authDomain: "enai-si.firebaseapp.com",
  databaseURL: "https://enai-si-default-rtdb.firebaseio.com",
  projectId: "enai-si",
  storageBucket: "enai-si.firebasestorage.app",
  messagingSenderId: "796550446327",
  appId: "1:796550446327:web:636483a584052f960be7f2",
  measurementId: "G-RJWEQ2QSBQ"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();
const storage = firebase.storage();

let usuarioAtual = null;

/* ===== LOGIN / CADASTRO ===== */
function login() {
  const email = document.getElementById('loginEmail').value;
  const senha = document.getElementById('loginSenha').value;
  firebase.auth().setPersistence(firebase.auth.Auth.Persistence.SESSION)
    .then(() => auth.signInWithEmailAndPassword(email, senha))
    .then(() => {
      showPage('painelPage');
      carregarVeiculo();
    })
    .catch(err => alert(err.message));
}

function cadastro() {
  const nome = document.getElementById('cadNome').value;
  const email = document.getElementById('cadEmail').value;
  const senha = document.getElementById('cadSenha').value;
  const chave = document.getElementById('cadKey').value;

  if (!chave) {
    alert("Por favor, insira sua chave de ativa√ß√£o.");
    return;
  }

  // Verifica se a chave existe no banco antes do cadastro
  db.ref('keys/' + chave).once('value').then(snapshot => {
    if (!snapshot.exists()) {
      alert("Chave inv√°lida ou n√£o registrada.");
      return;
    }

    auth.createUserWithEmailAndPassword(email, senha)
      .then(u => {
        const uid = u.user.uid;
        db.ref('usuarios/' + uid).set({
          nome,
          email,
          telefone: document.getElementById('cadTel').value,
          cpf: document.getElementById('cadCPF').value,
          endereco: document.getElementById('cadEndereco').value,
          key: chave
        });
        alert("Cadastro realizado com sucesso!");
        showPage('loginPage');
      })
      .catch(err => alert(err.message));
  });
}

function logout() {
  auth.signOut().then(() => showPage('loginPage'));
}

/* ===== LISTENER DE LOGIN (corrigido) ===== */
auth.onAuthStateChanged(user => {
  usuarioAtual = user;
  if (user) {
    console.log("Usu√°rio logado:", user.email);
    showPage('painelPage');
    carregarVeiculo();
    carregarPerfil();
  } else {
    console.log("Usu√°rio deslogado");
    showPage('loginPage');
  }
});

/* ===== PERFIL E DADOS DO VE√çCULO (mantidos do seu c√≥digo) ===== */
function carregarPerfil() {
  if (!usuarioAtual) return;
  const uid = usuarioAtual.uid;

  db.ref('usuarios/' + uid).once('value').then(snapshot => {
    const data = snapshot.val();
    if (!data) return;

    document.getElementById('perfilNome').value = data.nome || '';
    document.getElementById('perfilEmail').value = data.email || '';
    document.getElementById('perfilTel').value = data.telefone || '';
    document.getElementById('perfilCPF').value = data.cpf || '';
    document.getElementById('perfilEndereco').value = data.endereco || '';
    document.getElementById('perfilFabricante').value = data.fabricante || '';
    document.getElementById('perfilModelo').value = data.modelo || '';
    document.getElementById('perfilPlaca').value = data.placa || '';
    document.getElementById('perfilAno').value = data.ano || '';
    document.getElementById('perfilCor').value = data.cor || '';
    document.getElementById('perfilKey').value = data.key || '';

    const veiculoImg = document.getElementById('veiculoFoto');
    veiculoImg.src = data.veiculoFotoURL || '';
    veiculoImg.style.display = data.veiculoFotoURL ? 'block' : 'none';
  });
}

function carregarVeiculo() {
  if (!usuarioAtual) return;
  const uid = usuarioAtual.uid;
  db.ref('usuarios/' + uid).once('value').then(snapshot => {
    const data = snapshot.val();
    if (!data) return;
    document.getElementById('viewFabricante').textContent = data.fabricante || '‚Äî';
    document.getElementById('viewModelo').textContent = data.modelo || '‚Äî';
    document.getElementById('viewPlaca').textContent = data.placa || '‚Äî';
    document.getElementById('viewAno').textContent = data.ano || '‚Äî';
    document.getElementById('viewCor').textContent = data.cor || '‚Äî';
    const img = document.getElementById('veiculoFoto');
    img.src = data.veiculoFotoURL || '';
    img.style.display = data.veiculoFotoURL ? 'block' : 'none';
  });
}

/* ===== CONTROLE DO CARRO ===== */
function toggleMotor() {
  window.estadoCarro.motor = !window.estadoCarro.motor;
  const status = document.getElementById('motorStatus');
  const botao = document.getElementById('motorPower');
  if (window.estadoCarro.motor) {
    status.textContent = 'Ligado';
    status.className = 'on';
    botao.style.backgroundColor = '#3399ff';
  } else {
    status.textContent = 'Desligado';
    status.className = 'off';
    botao.style.backgroundColor = '#003366';
  }
  atualizarResumoVoz();
}

function toggleAr() {
  window.estadoCarro.ar = !window.estadoCarro.ar;
  const status = document.getElementById('statusAr');
  const botao = document.getElementById('arPower');
  if (window.estadoCarro.ar) {
    status.textContent = 'Ligado';
    status.className = 'on';
    botao.style.backgroundColor = '#33ccff';
  } else {
    status.textContent = 'Desligado';
    status.className = 'off';
    botao.style.backgroundColor = '#444';
  }
  atualizarResumoVoz();
}

function alterarTemp(v) {
  window.estadoCarro.temperatura += v;
  if (window.estadoCarro.temperatura < 14) window.estadoCarro.temperatura = 14;
  if (window.estadoCarro.temperatura > 28) window.estadoCarro.temperatura = 28;
  document.getElementById('tempAr').textContent = window.estadoCarro.temperatura;
  atualizarResumoVoz();
}

function alterarFreq(delta) {
  window.estadoCarro.radio = Math.round((window.estadoCarro.radio + delta) * 10) / 10;
  document.getElementById('radioFreq').textContent = window.estadoCarro.radio.toFixed(1);
  atualizarResumoVoz();
}

// Travas 
function toggleTrava(n) {
  const el = document.getElementById('travaLed' + n);
  const btn = document.querySelector(`#travaPage button[onclick="toggleTrava(${n})"]`);
  
  if (el.textContent === 'Fechada') {
    el.textContent = 'Aberta';
    el.className = 'off';
    btn.textContent = 'Fechar';
  } else {
    el.textContent = 'Fechada';
    el.className = 'on';
    btn.textContent = 'Abrir';
  }
}

function abrirTudo() {
  for (let i = 1; i <= 5; i++) {
    const el = document.getElementById('travaLed' + i);
    const btn = document.querySelector(`#travaPage button[onclick="toggleTrava(${i})"]`);
    el.textContent = 'Aberta';
    el.className = 'off';
    btn.textContent = 'Fechar';
  }
}

function fecharTudo() {
  for (let i = 1; i <= 5; i++) {
    const el = document.getElementById('travaLed' + i);
    const btn = document.querySelector(`#travaPage button[onclick="toggleTrava(${i})"]`);
    el.textContent = 'Fechada';
    el.className = 'on';
    btn.textContent = 'Abrir';
  }
}

function updateVidro(n) {
  const val = parseInt(document.getElementById('vidro' + n).value);
  document.getElementById('v' + n + 'pct').textContent = val + "%";
  window.estadoCarro.vidros[n - 1] = val;
  atualizarResumoVoz();
}

/* ===== FUN√á√ÉO GLOBAL DE RESUMO ===== */
function atualizarResumoVoz() {
  const ec = window.estadoCarro;
  if (!ec) return;

  const el = (id) => document.getElementById(id);
  el("vozMotor").textContent = ec.motor ? "Ligado" : "Desligado";
  el("vozAr").textContent = ec.ar ? "Ligado" : "Desligado";
  el("vozTemp").textContent = ec.temperatura + "¬∞C";
  el("vozRadio").textContent = ec.radio + " MHz";
  el("vozTravas").textContent = ec.travas.every(t => t) ? "Fechadas" : "Abertas";

  const mediaVidros = Math.round(ec.vidros.reduce((a, b) => a + b, 0) / ec.vidros.length);
  el("vozVidros").textContent = mediaVidros + "% abertos";
}
window.atualizarResumoVoz = atualizarResumoVoz;

/* ===== TROCA DE ABA ===== */
function showPage(id) {
  document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  if (id === "vozPage") setTimeout(atualizarResumoVoz, 200);
}

/* ===== COMANDO DE VOZ ===== */
document.addEventListener('DOMContentLoaded', () => {
  let reconhecimento = null;
  let ouvindo = false;

  function falar(texto) {
    const fala = new SpeechSynthesisUtterance(texto);
    fala.lang = 'pt-BR';
    speechSynthesis.speak(fala);
  }

  function iniciarReconhecimento() {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) return alert('Reconhecimento de voz n√£o suportado.');

    reconhecimento = new SR();
    reconhecimento.lang = 'pt-BR';
    reconhecimento.onstart = () => {
      ouvindo = true;
      document.getElementById('vozStatus').textContent = 'üéôÔ∏è Ouvindo...';
      document.getElementById('btnVoz').textContent = "üõë Parar escuta";
      falar("Estou ouvindo seu comando.");
    };
    reconhecimento.onend = () => {
      ouvindo = false;
      document.getElementById('vozStatus').textContent = '‚úÖ Aguardando comando...';
      document.getElementById('btnVoz').textContent = "üé§ Iniciar comando de voz";
    };
    reconhecimento.onresult = (e) => {
      const texto = e.results[0][0].transcript.toLowerCase();
      document.getElementById('vozStatus').textContent = "Voc√™ disse: " + texto;
      processarComandoVoz(texto);
    };
    reconhecimento.start();
  }

  function processarComandoVoz(texto) {
    if (!texto.includes("enai")) return;
    if (texto.includes("ligar motor")) { toggleMotor(true); falar("Motor ligado."); }
    else if (texto.includes("desligar motor")) { toggleMotor(false); falar("Motor desligado."); }
    else if (texto.includes("ligar ar")) { toggleAr(true); falar("Ar ligado."); }
    else if (texto.includes("desligar ar")) { toggleAr(false); falar("Ar desligado."); }
    else if (texto.includes("aumentar temperatura")) { alterarTemp(1); falar("Temperatura aumentada."); }
    else if (texto.includes("diminuir temperatura")) { alterarTemp(-1); falar("Temperatura diminu√≠da."); }
    else if (texto.includes("abrir portas")) { abrirTudo(); falar("Portas abertas."); }
    else if (texto.includes("fechar portas")) { fecharTudo(); falar("Portas fechadas."); }
    else { falar("N√£o entendi o comando."); }

    atualizarResumoVoz();
  }

  document.getElementById("btnVoz").onclick = () => ouvindo ? reconhecimento.stop() : iniciarReconhecimento();
  document.getElementById("btnAtualizar").onclick = atualizarResumoVoz;
  document.getElementById("btnVoltar").onclick = () => showPage("painelPage");

  setInterval(() => {
    const vozAtiva = document.getElementById("vozPage")?.classList.contains("active");
    if (vozAtiva) atualizarResumoVoz();
  }, 2000);
});
</script>
</body>
</html>
