<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- T√≠tulo da aba -->
  <title>ENAI - Solu√ß√µes Inteligentes</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="enaifavicon.png">

  <!-- Para deixar mais completo e compat√≠vel com iPhones, iPads e Windows -->
  <link rel="apple-touch-icon" sizes="180x180" href="ENAI.png">
  <meta name="msapplication-TileImage" content="ENAI.png">
  <meta name="msapplication-TileColor" content="#ffffff">
  
<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<!-- Leaflet (OpenStreetMap) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
<style>
:root{
  --blue-1:#007bff;
  --blue-2:#0046a3;
  --bg:#f5f7fa;
  --muted:#666;
  --green:#1db954;
  --red:#e53935;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:'Segoe UI',Tahoma,Arial,sans-serif;
  background:var(--bg);
  color:#222;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}
header{
  background:linear-gradient(to right,var(--blue-1),var(--blue-2));
  padding:15px 30px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  color:white;
  box-shadow:0 4px 10px rgba(0,0,0,0.18);
  position:relative;
  z-index:3;
}
header h2{margin:0;font-size:20px;letter-spacing:0.2px;}
.logo-header{position:absolute;top:10px;right:30px;}
.logo-header img{height:35px;border-radius:10px;}
.wave-bg{
  position:absolute;top:0;left:0;width:100%;height:250px;
  background:url('476426a2-35c7-41f2-a34d-7acc92b47b11.png') no-repeat center top;
  background-size:cover;z-index:0;
}
.container{
  max-width:880px;
  margin:100px auto;
  background:#fff;
  border-radius:18px;
  box-shadow:0 6px 26px rgba(0,0,0,0.12);
  padding:36px;
  position:relative;
  z-index:2;
  min-height:420px;
  overflow:hidden;
}
.page{
  opacity:0;
  transform:translateY(18px);
  pointer-events:none;
  transition:opacity .38s ease,transform .38s ease;
  position:absolute;
  width:calc(100% - 72px);
  left:36px;top:36px;
}
.page.active{
  opacity:1;
  transform:translateY(0);
  pointer-events:auto;
  position:relative;
  width:auto;left:auto;top:auto;
}
h1{color:var(--blue-2);text-align:center;margin-top:0;}
input,select,textarea{
  width:100%;padding:10px 12px;margin:8px 0;border-radius:8px;
  border:1px solid #d5dbe3;font-size:14px;
}
button{
  background:var(--blue-1);color:#fff;border:none;border-radius:10px;
  padding:10px 16px;margin:6px 6px 0 0;cursor:pointer;font-weight:600;
  transition:background .18s ease,transform .06s ease;
}
button:hover{background:var(--blue-2);transform:translateY(-2px);}
.muted{color:var(--muted);font-size:13px;}
.row{display:flex;gap:12px;flex-wrap:wrap;}
.col{flex:1;min-width:150px;}
.on{color:var(--green);font-weight:700;}
.off{color:var(--red);font-weight:700;}
.slider{width:100%;margin:6px 0;-webkit-appearance:none;height:8px;background:#e6e9ee;border-radius:6px;outline:none;}
.slider::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;border-radius:50%;background:var(--blue-1);cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,0.12);}
.vehicle-card{display:flex;gap:16px;align-items:center;border:1px solid #eef2f6;padding:12px;border-radius:12px;}
.vehicle-img{width:170px;height:120px;background:#f3f5f7;border-radius:10px;object-fit:cover;border:2px solid var(--blue-1);}
#mapid{width:100%;height:300px;border-radius:10px;margin-top:10px;}
@media(max-width:720px){
  .container{margin:60px 12px;padding:20px;}
  .page{width:100%;left:0;top:0;}
  .vehicle-img{width:120px;height:90px;}
}
</style>
</head>
<body>
<header>
  <h2 class="font-bold">ENAI - Solu√ß√µes Inteligentes</h2>
  <div class="logo-header"><img src="ENAI.png" alt="Logo"></div>
</header>
<div class="wave-bg"></div>

<div class="container">
  <!-- LOGIN -->
  <div id="loginPage" class="page active">
    <h1 class="text-4xl font-bold">Login</h1>
    <input id="loginEmail" type="email" placeholder="Email">
    <input id="loginSenha" type="password" placeholder="Senha">
    <div>
      <button onclick="login()">Entrar</button>
      <button onclick="showPage('cadastroPage')">Cadastre-se</button>
    </div>
    <p class="muted" style="margin-top:10px;"><a href="#" onclick="resetarSenha()">Esqueci minha senha</a></p>
  </div>

  <!-- CADASTRO -->
  <div id="cadastroPage" class="page">
    <h1 class="text-4xl font-bold">Cadastro</h1>
    <input id="cadNome" placeholder="Nome completo">
    <input id="cadEmail" placeholder="Email">
    <input id="cadTel" placeholder="Telefone">
    <input id="cadCPF" placeholder="CPF">
    <input id="cadEndereco" placeholder="Endere√ßo">
    <input id="cadSenha" type="password" placeholder="Senha">
    <div>
      <button onclick="cadastro()">Cadastrar</button>
      <button onclick="showPage('loginPage')">Voltar</button>
    </div>
  </div>

  <!-- PAINEL -->
  <div id="painelPage" class="page">
    <h1 class="text-4xl font-bold">Painel do Ve√≠culo</h1>
    <div style="margin-top:12px;" class="flex flex-col flex-wrap md:flex-row">
      <button onclick="showPage('perfilPage')">Meu Perfil</button>
      <button onclick="showPage('meuVeiculoPage')">Meu Ve√≠culo</button>
      <button onclick="showPage('travaPage')">Trava de Portas</button>
      <button onclick="showPage('vidrosPage')">Vidros</button>
      <button onclick="showPage('motorPage')">Motor</button>
      <button onclick="showPage('arPage')">Ar Condicionado</button>
      <button onclick="showPage('radioPage')">R√°dio</button>
      <button onclick="abrirGPS()">GPS</button>
      <button onclick="showPage('vozPage')">Comando de Voz</button>
      <button onclick="showPage('manutPage')">Plano de Manuten√ß√£o</button>
      <button onclick="logout()">Sair</button>
    </div>
  </div>

 <!-- PERFIL -->
  <div id="perfilPage" class="page">
    <h1 class="text-4xl font-bold">Meu Perfil</h1>
    <label>Nome</label>
    <input id="perfilNome" placeholder="Nome completo">
    <label>Email</label>
    <input id="perfilEmail" placeholder="Email" disabled>
    <label>Telefone</label>
    <input id="perfilTel" placeholder="Telefone">
    <label>CPF</label>
    <input id="perfilCPF" placeholder="CPF">
    <label>Endere√ßo</label>
    <input id="perfilEndereco" placeholder="Endere√ßo">

    <h1 style="font-size:18px; margin-top:12px;">Dados do Ve√≠culo</h1>
    <label>Fabricante</label>
    <input id="perfilFabricante" placeholder="Fabricante">
    <label>Modelo</label>
    <input id="perfilModelo" placeholder="Modelo">
    <div class="row">
      <div class="col">
        <label>Placa</label>
        <input id="perfilPlaca" placeholder="Placa">
      </div>
      <div class="col">
        <label>Ano</label>
        <input id="perfilAno" placeholder="Ano">
      </div>
    </div>
    <label>Cor</label>
    <input id="perfilCor" placeholder="Cor">
    <div style="margin-top:10px;">
      <button onclick="salvarPerfilCompleto()">Salvar</button>
      <button onclick="showPage('painelPage')">Voltar</button>
    </div>
  </div>

<!-- MEU VE√çCULO -->
<div id="meuVeiculoPage" class="page">
  <h1 class="text-4xl font-bold">Meu Ve√≠culo</h1>
  <div class="vehicle-card" style="margin-top:12px; display: flex; align-items: center; gap: 12px;">
    <img id="veiculoFoto" src="" alt="Foto do ve√≠culo" style="display:none; width:120px; height:auto; border-radius:8px; margin-top:10px;">
    <div style="flex: 1;">
      <div><strong>Fabricante:</strong> <span id="viewFabricante">‚Äî</span></div>
      <div><strong>Modelo:</strong> <span id="viewModelo">‚Äî</span></div>
      <div><strong>Placa:</strong> <span id="viewPlaca">‚Äî</span></div>
      <div><strong>Ano:</strong> <span id="viewAno">‚Äî</span></div>
      <div><strong>Cor:</strong> <span id="viewCor">‚Äî</span></div>
    </div>
  </div>

  <div style="margin-top:12px;">
    <label>Alterar foto do ve√≠culo</label><br>
    <input type="file" id="fotoVeiculoInput" accept="image/*" onchange="uploadFotoVeiculoFromPanel(event)">
  </div>

  <div style="margin-top:12px;">
    <button onclick="carregarVeiculo()">Atualizar Dados</button>
    <button onclick="showPage('painelPage')">Voltar</button>
  </div>
</div>

   <!-- TRAVAS -->
<div id="travaPage" class="page">
  <h1 class="text-4xl font-bold">Trava de Portas</h1>
  <div style="margin-top:12px;">
    <div style="margin-bottom:8px;">
      <strong>Esq Dianteira:</strong> 
      <span id="travaLed1" class="on">Fechada</span> 
      <button id="botaoTrava1" onclick="toggleTrava(1)">Abrir</button>
    </div>
    <div style="margin-bottom:8px;">
      <strong>Esq Traseira:</strong> 
      <span id="travaLed2" class="on">Fechada</span> 
      <button id="botaoTrava2" onclick="toggleTrava(2)">Abrir</button>
    </div>
    <div style="margin-bottom:8px;">
      <strong>Dir Dianteira:</strong> 
      <span id="travaLed3" class="on">Fechada</span> 
      <button id="botaoTrava3" onclick="toggleTrava(3)">Abrir</button>
    </div>
    <div style="margin-bottom:8px;">
      <strong>Dir Traseira:</strong> 
      <span id="travaLed4" class="on">Fechada</span> 
      <button id="botaoTrava4" onclick="toggleTrava(4)">Abrir</button>
    </div>
    <div style="margin-bottom:8px;">
      <strong>Porta-malas:</strong> 
      <span id="travaLed5" class="on">Fechada</span> 
      <button id="botaoTrava5" onclick="toggleTrava(5)">Abrir</button>
    </div>
  </div>
  <div style="margin-top:12px;">
    <button onclick="abrirTudo()">Abrir Tudo</button>
    <button onclick="fecharTudo()">Fechar Tudo</button>
    <button onclick="showPage('painelPage')">Voltar</button>
  </div>
</div>

  <!-- VIDROS -->
  <div id="vidrosPage" class="page">
    <h1 class="text-4xl font-bold">Vidros</h1>
    <div style="margin-top:12px;">
      <label>Vidro Dianteiro Esquerdo: <span id="v1pct">100%</span></label>
      <input id="vidro1" class="slider" type="range" min="0" max="100" value="100" oninput="updateVidro(1)">
      <label>Vidro Dianteiro Direito: <span id="v2pct">100%</span></label>
      <input id="vidro2" class="slider" type="range" min="0" max="100" value="100" oninput="updateVidro(2)">
      <label>Vidro Traseiro Esquerdo: <span id="v3pct">100%</span></label>
      <input id="vidro3" class="slider" type="range" min="0" max="100" value="100" oninput="updateVidro(3)">
      <label>Vidro Traseiro Direito: <span id="v4pct">100%</span></label>
      <input id="vidro4" class="slider" type="range" min="0" max="100" value="100" oninput="updateVidro(4)">
    </div>
    <div style="margin-top:12px;">
      <button onclick="showPage('painelPage')">Voltar</button>
    </div>
  </div>

  <!-- MOTOR -->
<div id="motorPage" class="page">
  <h1 class="text-4xl font-bold">Motor</h1>
  <p>Status: <span id="motorStatus" class="off">Desligado</span></p>

  <div style="margin-top: 16px;">
    <!-- Bot√£o com √≠cone -->
    <button id="motorPower" onclick="toggleMotor()"
      style="background-color:#003366; border:none; border-radius:50%; padding:18px; cursor:pointer; transition: background-color 0.3s;">
      <img src="70051.png" alt="Power" width="80" height="80">
    </button>

    <button style="margin-left:12px;" onclick="showPage('painelPage')">Voltar</button>
  </div>
</div>

  <!-- AR -->
<div id="arPage" class="page">
  <h1 class="text-4xl font-bold">Ar Condicionado</h1>
  <p>Status: <span id="statusAr" class="off">Desligado</span></p>

  <div style="margin-top:16px;">
    <!-- Bot√£o com √≠cone -->
    <button id="arPower" onclick="toggleAr()"
      style="background-color:#003366; border:none; border-radius:50%; padding:18px; cursor:pointer; transition: background-color 0.3s;">
      <img src="70051.png" alt="Power" width="40" height="40">
    </button>

    <button onclick="alterarTemp(-1)" style="margin-left:16px;">-</button>
    <span style="margin:0 12px">Temperatura: <strong><span id="tempAr">22</span>¬∞C</strong></span>
    <button onclick="alterarTemp(1)">+</button>

    <button style="margin-left:12px;" onclick="showPage('painelPage')">Voltar</button>
  </div>
</div>

  <!-- RADIO -->
  <div id="radioPage" class="page">
    <h1 class="text-4xl font-bold">R√°dio</h1>
    <p>Frequ√™ncia: <span id="radioFreq">99.5</span> MHz</p>
    <div>
      <button onclick="alterarFreq(-0.1)">-</button>
      <button onclick="alterarFreq(0.1)">+</button>
      <button onclick="showPage('painelPage')">Voltar</button>
    </div>
  </div>

  <!-- GPS -->
  <div id="gpsPage" class="page">
    <h1 class="text-4xl font-bold">GPS - Localiza√ß√£o Atual</h1>
    <div id="mapid">Carregando mapa...</div>
    <button style="margin-top:12px;" onclick="showPage('painelPage')">Voltar</button>
  </div>

  <!-- COMANDO DE VOZ -->
<div id="vozPage" class="page">
  <h1 class="text-4xl font-bold">Comando de Voz</h1>
  <p>Fale comandos iniciando com <strong>"ENAI"</strong> para controlar o ve√≠culo.</p>

  <div style="margin-top:10px;">
    <button id="btnVoz">üé§ Iniciar Comando de Voz</button>
    <p id="vozStatus" class="muted" style="margin-top:8px;">Aguardando comando...</p>
  </div>

  <div style="margin-top:20px;">
    <h2 style="font-size:18px;">üìä Estado Atual do Ve√≠culo</h2>
    <ul style="list-style:none; padding:0;">
      <li><strong>Motor:</strong> <span id="vozMotor"></span></li>
      <li><strong>Ar Condicionado:</strong> <span id="vozAr"></span> ‚Äî <span id="vozTemp"></span>¬∞C</li>
      <li><strong>R√°dio:</strong> <span id="vozRadio"></span> MHz</li>
      <li><strong>Travas:</strong> <span id="vozTravas"></span></li>
      <li><strong>Vidros:</strong> <span id="vozVidros"></span></li>
    </ul>
  </div>

  <div style="margin-top:12px;">
    <button id="btnAtualizar">üîÑ Atualizar Estado</button>
    <button id="btnVoltar">Voltar</button>
  </div>
</div>

  <!-- MANUTEN√á√ÉO -->
  <div id="manutPage" class="page">
    <h1 class="text-4xl font-bold">Plano de Manuten√ß√£o</h1>
    <p>Controle de revis√µes e alertas do ve√≠culo:</p>
    <ul>
      <li>Troca de √≥leo ‚Äì a cada 10.000 km</li>
      <li>Revis√£o de freios ‚Äì a cada 15.000 km</li>
      <li>Troca de filtro de ar ‚Äì a cada 20.000 km</li>
    </ul>
    <button onclick="showPage('painelPage')">Voltar</button>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBmPCQdVhQZt51ZnFwur8nRmGIpRdWBfEs",
  authDomain: "enai-si.firebaseapp.com",
  databaseURL: "https://enai-si-default-rtdb.firebaseio.com",
  projectId: "enai-si",
  storageBucket: "enai-si.firebasestorage.app",
  messagingSenderId: "796550446327",
  appId: "1:796550446327:web:636483a584052f960be7f2",
  measurementId: "G-RJWEQ2QSBQ"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();
const storage = firebase.storage();

let usuarioAtual = null;
let motorLigado = false;
let arLigado = false;
let tempAtual = 22;

function showPage(id){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function login(){
  const email = document.getElementById('loginEmail').value;
  const senha = document.getElementById('loginSenha').value;
  firebase.auth().setPersistence(firebase.auth.Auth.Persistence.SESSION)
    .then(()=>{
      return auth.signInWithEmailAndPassword(email, senha);
    })
    .then(()=>{
      showPage('painelPage');
      carregarVeiculo();
    })
    .catch(err=> alert(err.message));
}

function cadastro(){
  const nome = document.getElementById('cadNome').value;
  const email = document.getElementById('cadEmail').value;
  const senha = document.getElementById('cadSenha').value;
  auth.createUserWithEmailAndPassword(email, senha)
    .then(u=>{
      const uid = u.user.uid;
      db.ref('usuarios/'+uid).set({
        nome,
        email,
        telefone: document.getElementById('cadTel').value,
        cpf: document.getElementById('cadCPF').value,
        endereco: document.getElementById('cadEndereco').value
      });
      alert("Cadastro realizado!");
      showPage('loginPage');
    })
    .catch(err=> alert(err.message));
}

function logout(){
  auth.signOut().then(()=> showPage('loginPage'));
}

function resetarSenha(){
  const email = document.getElementById('loginEmail').value;
  if(!email){ alert("Digite seu email para resetar."); return; }
  auth.sendPasswordResetEmail(email).then(()=> alert("Email enviado para resetar senha"));
}

// Fun√ß√µes Painel
function toggleMotor() {
  motorLigado = !motorLigado;

  const status = document.getElementById('motorStatus');
  const botao = document.getElementById('motorPower');

  if (motorLigado) {
    status.textContent = 'Ligado';
    status.className = 'on';
    botao.style.backgroundColor = '#3399ff'; // Azul claro
  } else {
    status.textContent = 'Desligado';
    status.className = 'off';
    botao.style.backgroundColor = '#003366'; // Azul escuro
  }
}
function toggleAr() {
  arLigado = !arLigado;

  const status = document.getElementById('statusAr');
  const botao = document.getElementById('arPower');

  if (arLigado) {
    status.textContent = 'Ligado';
    status.className = 'on';
    botao.style.backgroundColor = '#33ccff'; // Azul claro
  } else {
    status.textContent = 'Desligado';
    status.className = 'off';
    botao.style.backgroundColor = '#444'; // Cinza escuro
  }
}
function alterarTemp(valor) {
  // Garante que estamos sempre lidando com n√∫mero
  const tempSpan = document.getElementById('tempAr');
  temperatura = parseInt(tempSpan.textContent) + valor;

  // Limita a temperatura
  if (temperatura < 14) temperatura = 14;
  if (temperatura > 28) temperatura = 28;

  // Atualiza na tela
  tempSpan.textContent = temperatura;
}
function alterarFreq(delta){
  let freq = parseFloat(document.getElementById('radioFreq').textContent);
  freq = Math.round((freq+delta)*10)/10;
  document.getElementById('radioFreq').textContent = freq.toFixed(1);
}

// Vidros
function updateVidro(n){
  const val = document.getElementById('vidro'+n).value;
  document.getElementById('v'+n+'pct').textContent = val + "%";
}

/// Travas
function toggleTrava(n) {
  const el = document.getElementById('travaLed' + n);
  const botao = document.getElementById('botaoTrava' + n);

  if (el.textContent === 'Fechada') {
    el.textContent = 'Aberta';
    el.className = 'off';
    botao.textContent = 'Fechar';
  } else {
    el.textContent = 'Fechada';
    el.className = 'on';
    botao.textContent = 'Abrir';
  }
}

function abrirTudo() {
  for (let i = 1; i <= 5; i++) {
    const el = document.getElementById('travaLed' + i);
    const botao = document.getElementById('botaoTrava' + i);
    el.textContent = 'Aberta';
    el.className = 'off';
    botao.textContent = 'Fechar';
  }
}

function fecharTudo() {
  for (let i = 1; i <= 5; i++) {
    const el = document.getElementById('travaLed' + i);
    const botao = document.getElementById('botaoTrava' + i);
    el.textContent = 'Fechada';
    el.className = 'on';
    botao.textContent = 'Abrir';
  }
}

// Perfil
function salvarPerfilCompleto(){
  if(!usuarioAtual){ alert("Fa√ßa login"); return; }
  const uid = usuarioAtual.uid;
  db.ref('usuarios/'+uid).update({
    nome: document.getElementById('perfilNome').value,
    telefone: document.getElementById('perfilTel').value,
    cpf: document.getElementById('perfilCPF').value,
    endereco: document.getElementById('perfilEndereco').value,
    fabricante: document.getElementById('perfilFabricante').value,
    modelo: document.getElementById('perfilModelo').value,
    placa: document.getElementById('perfilPlaca').value,
    ano: document.getElementById('perfilAno').value,
    cor: document.getElementById('perfilCor').value
  });
  alert("Perfil salvo!");
}

function carregarPerfil() {
  if (!usuarioAtual) return;
  const uid = usuarioAtual.uid;

  db.ref('usuarios/' + uid).once('value').then(snapshot => {
    const data = snapshot.val();
    if (!data) return;

    // Perfil
    document.getElementById('perfilNome').value = data.nome || '';
    document.getElementById('perfilEmail').value = data.email || '';
    document.getElementById('perfilTel').value = data.telefone || '';
    document.getElementById('perfilCPF').value = data.cpf || '';
    document.getElementById('perfilEndereco').value = data.endereco || '';

    // Dados do ve√≠culo (opcional, se quiser mostrar tamb√©m)
    document.getElementById('perfilFabricante').value = data.fabricante || '';
    document.getElementById('perfilModelo').value = data.modelo || '';
    document.getElementById('perfilPlaca').value = data.placa || '';
    document.getElementById('perfilAno').value = data.ano || '';
    document.getElementById('perfilCor').value = data.cor || '';

    // Foto do ve√≠culo
    const veiculoImg = document.getElementById('veiculoFoto');
    if (data.veiculoFotoURL) {
      veiculoImg.src = data.veiculoFotoURL;
      veiculoImg.style.display = 'block';
    } else {
      veiculoImg.src = '';
      veiculoImg.style.display = 'none';
    }

    // Foto do perfil (opcional)
    const perfilImg = document.getElementById('perfilFotoPreview');
    if (data.perfilFotoURL) {
      perfilImg.src = data.perfilFotoURL;
      perfilImg.style.display = 'block';
    } else {
      perfilImg.src = '';
      perfilImg.style.display = 'none';
    }
  });
}

// Fotos
function uploadFotoPerfil(event){
  const file = event.target.files[0];
  if(!file || !usuarioAtual) return;
  const uid = usuarioAtual.uid;
  const storageRef = storage.ref('usuarios/'+uid+'/perfil.jpg');
  storageRef.put(file).then(()=> {
    storageRef.getDownloadURL().then(url=>{
      document.getElementById('perfilFotoPreview').src=url;
      document.getElementById('perfilFotoPreview').style.display='block';
    });
  });
}

function uploadFotoVeiculoFromPanel(event) {
  const file = event.target.files[0];
  if (!file || !usuarioAtual) {
    alert("Selecione uma imagem e fa√ßa login antes de enviar.");
    return;
  }

  const uid = usuarioAtual.uid;
  const preview = document.getElementById("veiculoFoto"); // imagem no HTML

  // 1Ô∏è‚É£ Mostra a miniatura localmente antes do upload
  const reader = new FileReader();
  reader.onload = (e) => {
    preview.src = e.target.result;
    preview.style.display = "block";
  };
  reader.readAsDataURL(file);

  // 2Ô∏è‚É£ Faz upload pro Firebase Storage
  const storageRef = firebase.storage().ref("usuarios/" + uid + "/veiculo.jpg");
  storageRef.put(file).then(() => {
    // 3Ô∏è‚É£ Depois pega o link p√∫blico e salva no Realtime Database
    storageRef.getDownloadURL().then((url) => {
      firebase.database().ref("usuarios/" + uid + "/veiculoFotoURL").set(url);
      console.log("Foto do ve√≠culo enviada com sucesso:", url);
    });
  }).catch((error) => {
    console.error("Erro ao enviar a foto do ve√≠culo:", error);
    alert("Erro ao enviar a imagem. Tente novamente.");
  });
}

// Carrega dados do ve√≠culo + foto
function carregarVeiculo() {
  if (!usuarioAtual) return;
  const uid = usuarioAtual.uid;

  db.ref('usuarios/' + uid).once('value').then(snapshot => {
    const data = snapshot.val();
    if (!data) return;

    document.getElementById('viewFabricante').textContent = data.fabricante || '‚Äî';
    document.getElementById('viewModelo').textContent = data.modelo || '‚Äî';
    document.getElementById('viewPlaca').textContent = data.placa || '‚Äî';
    document.getElementById('viewAno').textContent = data.ano || '‚Äî';
    document.getElementById('viewCor').textContent = data.cor || '‚Äî';

    const img = document.getElementById('veiculoFoto');
    if (data.veiculoFotoURL) {
      img.src = data.veiculoFotoURL;
      img.style.display = 'block';
    } else {
      img.src = '';
      img.style.display = 'none';
    }
  });
}

// === GPS FUNCIONAL (OpenStreetMap / Leaflet) ===
let map=null;
function abrirGPS(){
  showPage('gpsPage');
  if(map===null){
    map=L.map('mapid').setView([-14.235,-51.9253],4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      maxZoom:19,attribution:'¬© OpenStreetMap'
    }).addTo(map);
  }
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      const lat=pos.coords.latitude;
      const lon=pos.coords.longitude;
      map.setView([lat,lon],15);
      L.marker([lat,lon]).addTo(map).bindPopup("Voc√™ est√° aqui!").openPopup();
    },err=>{
      alert("N√£o foi poss√≠vel obter a localiza√ß√£o.");
    });
  }else alert("Geolocaliza√ß√£o n√£o suportada neste navegador.");
}

// Monitorar login
auth.onAuthStateChanged(user => {
  usuarioAtual = user;
  if(user){
    showPage('painelPage');
    carregarVeiculo();
    carregarPerfil(); // <--- adiciona aqui
  } else {
    showPage('loginPage');
  }

// === COMANDO DE VOZ (com sincroniza√ß√£o total + fala) ===
let reconhecimento = null;
let ouvindo = false;

function falar(texto) {
  const msg = new SpeechSynthesisUtterance(texto);
  msg.lang = "pt-BR";
  msg.rate = 1;
  msg.pitch = 1;
  const vozBR = speechSynthesis.getVoices().find(v => v.lang === "pt-BR");
  if (vozBR) msg.voice = vozBR;
  speechSynthesis.speak(msg);
}

// üîÑ Atualiza o painel de status lendo os valores atuais do DOM
function atualizarResumoVoz() {
  // Motor
  const motorStatus = document.getElementById('motorStatus');
  document.getElementById('vozMotor').textContent =
    motorStatus ? motorStatus.textContent : "Indefinido";

  // Ar-condicionado
  const arStatus = document.getElementById('arStatus');
  const tempLabel = document.getElementById('tempLabel');
  document.getElementById('vozAr').textContent = arStatus ? arStatus.textContent : "Indefinido";
  document.getElementById('vozTemp').textContent = tempLabel ? tempLabel.textContent.replace("¬∞C", "") : "-";

  // R√°dio
  const radioFreq = document.getElementById('radioFreq');
  document.getElementById('vozRadio').textContent = radioFreq ? radioFreq.textContent : "-";

  // Travas
  let travasFechadas = true;
  for (let i = 1; i <= 5; i++) {
    const trava = document.getElementById('travaLed' + i);
    if (trava && trava.textContent !== 'Fechada') travasFechadas = false;
  }
  document.getElementById('vozTravas').textContent = travasFechadas ? "Todas Fechadas" : "Alguma Aberta";

  // Vidros
  const vidros = [];
  for (let i = 1; i <= 4; i++) {
    const pct = document.getElementById('v' + i + 'pct');
    if (pct) vidros.push(pct.textContent);
  }
  document.getElementById('vozVidros').textContent = vidros.join(' / ');
}

// Escuta eventos nas outras abas e mant√©m sincronizado automaticamente
const observador = new MutationObserver(() => atualizarResumoVoz());
window.addEventListener('load', () => {
  const alvo = document.body;
  observador.observe(alvo, { childList: true, subtree: true, characterData: true });
  atualizarResumoVoz();
});

// üéôÔ∏è Controle do reconhecimento de voz
function toggleReconhecimento() {
  if (!('webkitSpeechRecognition' in window)) {
    alert("Reconhecimento de voz n√£o √© suportado neste navegador.");
    window.toggleReconhecimento = toggleReconhecimento;
    return;
  }

  if (!reconhecimento) {
    reconhecimento = new webkitSpeechRecognition();
    reconhecimento.lang = "pt-BR";
    reconhecimento.continuous = false;
    reconhecimento.interimResults = false;

    reconhecimento.onstart = () => {
      ouvindo = true;
      document.getElementById('vozStatus').textContent = "üéß Ouvindo... diga 'ENAI' seguido do comando.";
      document.getElementById('btnVoz').textContent = "üõë Parar Reconhecimento";
      falar("Ouvindo. Pode falar, iniciando com ENAI.");
    };

    reconhecimento.onend = () => {
      ouvindo = false;
      document.getElementById('vozStatus').textContent = "Aguardando comando...";
      document.getElementById('btnVoz').textContent = "üé§ Iniciar Comando de Voz";
    };

    reconhecimento.onerror = (e) => {
      ouvindo = false;
      document.getElementById('vozStatus').textContent = "Erro: " + e.error;
      falar("Ocorreu um erro no reconhecimento de voz.");
    };

    reconhecimento.onresult = (event) => {
      const texto = event.results[0][0].transcript.toLowerCase();
      document.getElementById('vozStatus').textContent = "Voc√™ disse: " + texto;
      processarComandoVoz(texto);
      atualizarResumoVoz();
    };
  }

  if (ouvindo) reconhecimento.stop();
  else reconhecimento.start();
}

// üì¢ Interpreta e executa os comandos de voz
function processarComandoVoz(frase) {
  if (!frase.includes("enai")) {
    falar("Diga ENAI antes do comando.");
    return;
  }

  // MOTOR
  if (frase.includes("ligar o motor") || frase.includes("ligar motor")) {
    toggleMotor(); falar("Motor ligado.");
  } else if (frase.includes("desligar o motor") || frase.includes("desligar motor")) {
    toggleMotor(); falar("Motor desligado.");
  }

  // AR
  else if (frase.includes("ligar o ar") || frase.includes("ligar ar")) {
    toggleAr(); falar("Ar-condicionado ligado.");
  } else if (frase.includes("desligar o ar") || frase.includes("desligar ar")) {
    toggleAr(); falar("Ar-condicionado desligado.");
  } else if (frase.includes("aumentar temperatura")) {
    alterarTemp(1); falar("Temperatura aumentada.");
  } else if (frase.includes("diminuir temperatura") || frase.includes("baixar temperatura")) {
    alterarTemp(-1); falar("Temperatura reduzida.");
  }

  // R√ÅDIO
  else if (frase.includes("aumentar r√°dio") || frase.includes("subir r√°dio")) {
    alterarFreq(0.1); falar("Aumentando frequ√™ncia do r√°dio.");
  } else if (frase.includes("diminuir r√°dio") || frase.includes("baixar r√°dio")) {
    alterarFreq(-0.1); falar("Diminuindo frequ√™ncia do r√°dio.");
  }

  // TRAVAS
  else if (frase.includes("abrir todas as portas") || frase.includes("abrir portas")) {
    abrirTudo(); falar("Abrindo todas as portas.");
  } else if (frase.includes("fechar todas as portas") || frase.includes("fechar portas")) {
    fecharTudo(); falar("Fechando todas as portas.");
  }

  // VIDROS
  else if (frase.includes("abrir todos os vidros")) {
    for (let i = 1; i <= 4; i++) {
      document.getElementById('vidro' + i).value = 100;
      updateVidro(i);
    }
    falar("Abrindo todos os vidros.");
  } else if (frase.includes("fechar todos os vidros")) {
    for (let i = 1; i <= 4; i++) {
      document.getElementById('vidro' + i).value = 0;
      updateVidro(i);
    }
    falar("Fechando todos os vidros.");
  }

  else if (frase.includes("abrir vidro")) {
    const match = frase.match(/vidro.*(\d+)%/);
    const pct = match ? parseInt(match[1]) : 100;
    for (let i = 1; i <= 4; i++) {
      document.getElementById('vidro' + i).value = pct;
      updateVidro(i);
    }
    falar(`Abrindo vidros em ${pct} por cento.`);
  } else if (frase.includes("fechar vidro")) {
    for (let i = 1; i <= 4; i++) {
      document.getElementById('vidro' + i).value = 0;
      updateVidro(i);
    }
    falar("Fechando vidros completamente.");
  } else {
    falar("Comando n√£o reconhecido.");
  }
}
});
</script>
</body>
</html>
